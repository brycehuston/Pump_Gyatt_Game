<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pump Gyatt â€” Carnival BB Shooter</title>
<style>
  :root { --bg:#0b0b12; --fg:#f7f7fb; --muted:#b6b6cf; --acc:#ff7a00; --card:#131327; --stroke:#29294a }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1400px 900px at 50% -10%, #1a1028 0%, var(--bg) 60%);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1400px;margin:0 auto;padding:16px}
  header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin:8px 0 14px}
  .title{font-weight:900;font-size:30px;letter-spacing:.6px}
  .row{display:flex;flex-wrap:wrap;gap:10px}
  .btn{cursor:pointer;background:#14142a;color:var(--fg);border:1px solid var(--stroke);border-radius:12px;padding:10px 14px;font-weight:700}
  .btn.primary{background:linear-gradient(135deg,var(--acc),#e84f9e)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .grid{display:grid;gap:12px}
  .card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:16px}
  .hud{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
  .stat{padding:10px 12px;border-radius:12px;background:var(--card);border:1px solid var(--stroke);font-weight:800;text-align:center}
  .stat .k{display:block;font-size:11px;letter-spacing:.4px;color:var(--muted)}
  .stat span:last-child{display:block;font-size:18px;margin-top:2px}
  #gameWrap{position:relative;aspect-ratio:16/9;width:100%;max-height:85vh;overflow:hidden;touch-action:none;cursor:none;perspective:900px}
  #game{width:100%;height:100%;display:block;background:#0b0b12;border-radius:12px}
  #gun{position:absolute;left:50%;top:100%;width:200px;opacity:.95;filter:drop-shadow(0 2px 4px rgba(0,0,0,.6));user-select:none;display:none;transform:translate(-50%,-100%);transform-origin:50% 100%}
  #overlay,#startOverlay{position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:radial-gradient(60% 50% at 50% 45%, rgba(0,0,0,.05), rgba(0,0,0,.85) 60%, rgba(0,0,0,.95)); z-index:5}
  .over-box{ text-align:center; padding:28px 24px; border-radius:16px; background:rgba(20,10,25,.55); border:1px solid rgba(255,255,255,.1); backdrop-filter: blur(4px); width:min(680px,92%); box-shadow:0 10px 40px rgba(0,0,0,.6), inset 0 0 60px rgba(255,90,0,.08)}
  .over-title{ font-size:54px; font-weight:900; letter-spacing:2px; margin:0 0 8px; color:#ffb36b; text-shadow: 0 0 12px rgba(255,120,0,.45), 0 0 30px rgba(255,60,0,.25); animation:flicker 2.2s infinite steps(2,end)}
  .over-sub{opacity:.9;margin-bottom:14px}
  .over-score{font-size:20px;margin:6px 0 14px}
  .over-actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
  .over-btn{cursor:pointer;background:#1a1a2a;color:#fff;border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:10px 16px;font-weight:800}
  .over-btn.primary{background:linear-gradient(135deg,#ff7a00,#e84f9e)}
  .bigPlay{font-size:26px;padding:16px 22px;border-radius:16px}
  .tag{padding:4px 8px;border-radius:999px;background:#1c1c2e;border:1px solid #2b2b47;font-weight:800;font-size:12px}
  .list{line-height:1.5;color:#ddd}
  @keyframes flicker{0%,18%,22%,25%,53%,57%,100%{opacity:1}20%,24%,55%{opacity:.65}}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">ðŸŽ¯ Pump Gyatt â€” Carnival BB Shooter</div>
      <div class="row">
        <button id="connectBtn" class="btn">Connect Phantom</button>
        <button id="signBtn" class="btn">Sign Score</button>
        <label class="btn">ðŸ”‡ Mute <input id="muteChk" type="checkbox" style="vertical-align:-2px;margin-left:6px"></label>
        <button id="submitBtn" class="btn" disabled>Save Local Score</button>
        <button id="shareBtn" class="btn">Share on X</button>
      </div>
    </header>

    <div class="row" style="align-items:flex-start; gap:14px">
      <div id="gameWrap" class="card" style="flex:1 1 900px">
        <canvas id="game"></canvas>

        <div id="startOverlay">
          <div class="over-box">
            <div class="over-title">PUMP GYATT</div>
            <div class="over-sub">Tap the pumpkins. Pumpkin butt = bonus. One glowing target at a time. Avoid bats. Ghosts are +5.</div>
            <div style="margin:10px 0 18px;opacity:.85">60s â€¢ Frenzy at 30s â€¢ Boss later â€¢ Sprinter once â€¢ Mobile friendly</div>
            <div class="over-actions">
              <button id="bigPlay" class="over-btn primary bigPlay">â–¶ Play</button>
              <label class="over-btn">ðŸ”‡ Mute <input id="muteStart" type="checkbox" style="vertical-align:-1px;margin-left:6px"></label>
            </div>
          </div>
        </div>

        <div id="overlay">
          <div class="over-box">
            <div class="over-title">GAME OVER</div>
            <div class="over-sub">the carnival claims another soulâ€¦</div>
            <div id="overScore" class="over-score"></div>
            <div class="over-actions">
              <button id="playAgainBtn" class="over-btn primary">Play Again</button>
              <button id="shareOverBtn" class="over-btn">Share on X</button>
              <button id="muteOverBtn" class="over-btn">Toggle Mute</button>
            </div>
          </div>
        </div>

        <img id="gun" alt="bb-gun" draggable="false" src="gun.png">
      </div>

      <div style="width:360px" class="grid">
        <div class="card">
          <div class="hud">
            <div class="stat"><span class="k">Score</span><span id="score">0</span></div>
            <div class="stat"><span class="k">Time</span><span id="time">60</span></div>
            <div class="stat"><span class="k">Combo</span><span id="combo">0</span></div>
            <div class="stat"><span class="k">Miss</span><span id="miss">0</span></div>
            <div class="stat"><span class="k">Rank</span><span id="rank">Rookie</span></div>
            <div class="stat"><span class="k">Best Rank</span><span id="bestRank">Rookie</span></div>
            <div class="stat"><span class="k">Mode</span><span id="mode">x1</span></div>
          </div>
        </div>

        <div class="card">
          <b>How to Play</b>
          <div class="list">
            Normal: body +1, pumpkin +2 â€¢ <span class="tag">Glowing +10</span> and rare <span class="tag">+5s</span><br>
            Boss (HP 6): body +2, pumpkin +4, glowing +12 â€¢ Bats âˆ’2 â€¢ Ghost +5<br>
            <span class="tag">Frenzy</span> at 30s: x2 score, faster spawns â€¢ Special sprinter appears once
          </div>
        </div>

        <div class="card">
          <b>Daily Mission</b>
          <div id="missionBox" class="list"></div>
          <button id="resetMission" class="btn" style="margin-top:8px">Reset</button>
        </div>

        <div class="card">
          <b>Leaderboard (local)</b>
          <ol id="board" class="list"></ol>
          <button id="refreshLb" class="btn" style="width:100%">Refresh</button>
        </div>

        <div class="card">
          <b>Wallet</b>
          <div id="walletBox" class="list">Not connected</div>
        </div>
      </div>
    </div>
  </div>

<script>
const cvs=document.getElementById('game'), ctx=cvs.getContext('2d');
const wrap=document.getElementById('gameWrap');
const startOverlay=document.getElementById('startOverlay');
const bigPlay=document.getElementById('bigPlay');
const muteStart=document.getElementById('muteStart');
const overlay=document.getElementById('overlay');
const overScoreEl=document.getElementById('overScore');
const playAgainBtn=document.getElementById('playAgainBtn');
const shareOverBtn=document.getElementById('shareOverBtn');
const muteOverBtn=document.getElementById('muteOverBtn');
const gunImg=document.getElementById('gun');
const scoreEl=document.getElementById('score');
const timeEl=document.getElementById('time');
const comboEl=document.getElementById('combo');
const missEl=document.getElementById('miss');
const rankEl=document.getElementById('rank');
const bestRankEl=document.getElementById('bestRank');
const modeEl=document.getElementById('mode');
const boardEl=document.getElementById('board');
const connectBtn=document.getElementById('connectBtn');
const signBtn=document.getElementById('signBtn');
const submitBtn=document.getElementById('submitBtn');
const shareBtn=document.getElementById('shareBtn');
const refreshLbBtn=document.getElementById('refreshLb');
const muteChk=document.getElementById('muteChk');
const walletBox=document.getElementById('walletBox');
const missionBox=document.getElementById('missionBox');
const resetMissionBtn=document.getElementById('resetMission');

let W=0,H=0,dpr=1;
function fit(){const r=wrap.getBoundingClientRect(); dpr=window.devicePixelRatio||1; W=r.width; H=r.height; cvs.width=W*dpr; cvs.height=H*dpr; cvs.style.width=W+'px'; cvs.style.height=H+'px'; ctx.setTransform(dpr,0,0,dpr,0,0)}
addEventListener('resize',fit); fit();

const isCoarse = matchMedia && matchMedia('(pointer: coarse)').matches;

const zombieImg=new Image(); zombieImg.src="zombie.png";
const bossImg=new Image(); bossImg.src="monster-zombie.png";
const batImg=new Image(); batImg.src="bat.png";
const ghostImg=new Image(); ghostImg.src="ghost.png";
const sprinterImg=new Image(); sprinterImg.src="glowing-pumpk.png";

const HITBOX_SCALE=0.9;

const pops=[], floats=[];
let rankFx=0, rankMax=1500, rankText="", comboFlame=0;

function spawnPop(x,y){ for(let i=0;i<9;i++) pops.push({x,y,vx:(Math.random()*2-1)*2.0,vy:(Math.random()*2-1)*1.8-0.5,r:2+Math.random()*2,life:220,t:0,h:28+Math.random()*10}) }
function addFloat(text,x,y,color,lifeMs=3000){ if(!isFinite(x)||!isFinite(y)) return; floats.push({text,x,y,vy:-0.18,life:lifeMs,t:0,color}) }
function updateFx(dt){
  for(const p of pops){ p.t+=dt; p.x+=p.vx; p.y+=p.vy; p.vy+=0.018 }
  for(let i=pops.length-1;i>=0;i--) if(pops[i].t>pops[i].life) pops.splice(i,1);
  for(const fl of floats){ fl.t+=dt; fl.y+=fl.vy }
  for(let i=floats.length-1;i>=0;i--) if(floats[i].t>floats[i].life) floats.splice(i,1);
  if(rankFx>0) rankFx=Math.max(0,rankFx-dt);
  if(comboFlame>0) comboFlame=Math.max(0,comboFlame-dt*0.8);
}

let parX=0, parY=0;
wrap.addEventListener('pointermove',e=>{ const r=wrap.getBoundingClientRect(); const x=(e.clientX-r.left)/r.width; const y=(e.clientY-r.top)/r.height; parX=x-0.5; parY=y-0.5 });

function drawMoon(x,y,r){
  const body=ctx.createRadialGradient(x-r*0.25,y-r*0.25,r*0.2,x,y,r*1.02);
  body.addColorStop(0,'#fffdf5'); body.addColorStop(0.6,'#e7e2d3'); body.addColorStop(1,'#c9c4b0');
  ctx.fillStyle=body; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
  ctx.save(); ctx.globalAlpha=0.18;
  for(let i=0;i<12;i++){ const a=(i*0.52)+0.7, rr=r*(0.04+0.06*Math.random()); const cx=x+Math.cos(a)*r*0.45, cy=y+Math.sin(a)*r*0.35; const g=ctx.createRadialGradient(cx,cy,rr*0.3,cx,cy,rr); g.addColorStop(0,'#918a75'); g.addColorStop(1,'rgba(145,138,117,0)'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(cx,cy,rr,0,Math.PI*2); ctx.fill() }
  ctx.restore();
  const term=ctx.createLinearGradient(x-r*0.6,y-r*0.6,x+r*0.6,y+r*0.6);
  term.addColorStop(0,'rgba(0,0,0,0.35)'); term.addColorStop(0.55,'rgba(0,0,0,0)');
  ctx.fillStyle=term; ctx.beginPath(); ctx.arc(x,y,r*1.02,0,Math.PI*2); ctx.fill();
  const haze=ctx.createRadialGradient(x,y,r*0.2,x,y,r*1.8);
  haze.addColorStop(0,'rgba(255,250,220,0.35)'); haze.addColorStop(1,'rgba(255,220,120,0)');
  ctx.fillStyle=haze; ctx.beginPath(); ctx.arc(x,y,r*1.6,0,Math.PI*2); ctx.fill();
}
function drawBackground(){
  const sky=ctx.createLinearGradient(0,0,0,H);
  sky.addColorStop(0,'#0f121a'); sky.addColorStop(1,'#090912');
  ctx.fillStyle=sky; ctx.fillRect(0,0,W,H);
  const moonX=W*0.82+parX*14, moonY=H*0.18+parY*8; drawMoon(moonX,moonY,60);
  const t=performance.now()/1000;
  ctx.globalAlpha=0.22;
  for(let i=0;i<3;i++){ const cx=(t*10+i*140)% (W+240) -120; ctx.beginPath(); ctx.ellipse(cx, moonY+20+i*10, 120-i*10, 30-i*6, 0, 0, Math.PI*2); ctx.fillStyle='rgba(200,200,220,0.18)'; ctx.fill() }
  ctx.globalAlpha=1;
  ctx.fillStyle='#0b0f14';
  for(let i=0;i<5;i++){ const y=H*0.58+i*18, sway=Math.sin(t*0.8+i)*8; ctx.beginPath(); ctx.moveTo(-50, H); for(let x=0;x<=W+50;x+=48){ const ty = y + Math.sin((x*0.01)+i)*14 + sway; ctx.lineTo(x, ty) } ctx.lineTo(W+50,H); ctx.closePath(); ctx.fill() }
  ctx.save(); ctx.translate(parX*20, parY*10); for(let i=0;i<3;i++){ const baseY=H*0.60+i*38; drawTent(-60+i*(W/3.2), baseY, W/3.2+40, 90-i*10, i) } ctx.restore();
  drawCurtains(); drawLantern(60+parX*8, 48+parY*4); drawLantern(W-60+parX*8, 48+parY*4); drawFloor();
}
function drawTent(x,y,w,h,i){ ctx.save(); const stripe='#3b1b4a', stripe2='#d14f2b'; ctx.fillStyle='#1a0f27'; ctx.fillRect(x,y-h,w,h); const stripeW=22; for(let sx=x; sx<x+w; sx+=stripeW){ ctx.fillStyle = ((Math.floor((sx-x)/stripeW)%2)===0)?stripe:stripe2; ctx.fillRect(sx,y-h,stripeW,h) } ctx.fillStyle='#c9a23a'; ctx.fillRect(x,y-h-12,w,12); ctx.restore() }
function drawCurtains(){ const grd=ctx.createLinearGradient(0,0,0,140); grd.addColorStop(0,'#6c0d24'); grd.addColorStop(1,'#2a0610'); ctx.fillStyle=grd; ctx.fillRect(0,0,60,H*0.55); ctx.fillRect(W-60,0,60,H*0.55); ctx.fillStyle='#caa84a'; ctx.fillRect(0,0,W,16); ctx.fillRect(0,H*0.55-12,W,12); for(let i=0;i<8;i++){ ctx.beginPath(); ctx.arc(i*(W/8)+W/16, 16, 6, 0, Math.PI*2); ctx.fill() } }
function drawLantern(x,y){ const flick=0.7+0.3*Math.sin(performance.now()/120 + x); ctx.save(); ctx.translate(x,y); ctx.fillStyle='#caa84a'; ctx.fillRect(-2,-8,4,8); const g=ctx.createRadialGradient(0,0,2,0,0,18); g.addColorStop(0,`rgba(255,240,160,${0.9*flick})`); g.addColorStop(1,`rgba(255,140,0,0)`); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(0,0,18,0,Math.PI*2); ctx.fill(); ctx.restore() }
function drawFloor(){ const y=H-64; ctx.fillStyle='#2b2342'; ctx.fillRect(0,y,W,64); ctx.fillStyle='#1e1831'; for(let i=0;i<W;i+=64){ ctx.fillRect(i,y,56,4) } ctx.fillStyle='rgba(255,255,255,0.06)'; for(let i=0;i<6;i++){ ctx.fillRect(0,y-6-i*70,W,2) } }

function drawChar(t){
  const img=(t.kind==='boss')?bossImg:(t.kind==='sprinter'?sprinterImg:zombieImg);
  const tt=(performance.now()-t.animStart)/1000;
  const step=Math.sin(tt*6+t.seed)*t.stepAmp;
  const bob=Math.sin(tt*3+t.seed)*t.bobAmp;
  const rot=Math.sin(tt*4+t.seed)*t.swayAmp;
  const squash=Math.sin(tt*6+t.seed)*t.squashAmp;
  ctx.save();
  const laneWobble=Math.sin(tt*2+t.seed)*1.0;
  ctx.translate(t.x+(t.flip?-step:step), t.y+bob+laneWobble);
  ctx.scale(t.flip?-1:1,1);
  ctx.rotate(rot);
  ctx.scale(1+squash,1-squash);
  if(img.complete) ctx.drawImage(img,-t.w/2,-t.h,t.w,t.h);
  const phase = tt*7.2+t.seed; const leftLift = Math.max(0, Math.sin(phase))*8; const rightLift = Math.max(0, Math.sin(phase+Math.PI))*8; const spread = 12;
  ctx.globalAlpha=0.6; ctx.fillStyle='rgba(0,0,0,0.55)'; ctx.beginPath(); ctx.ellipse(-spread, 8, 14, 5, 0, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.ellipse( spread, 8, 14, 5, 0, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha=1;
  ctx.strokeStyle='rgba(60,50,70,0.9)'; ctx.lineWidth=4; ctx.beginPath(); ctx.moveTo(-spread, -t.h*0.08 - leftLift); ctx.lineTo(-spread, 6); ctx.stroke(); ctx.beginPath(); ctx.moveTo( spread, -t.h*0.08 - rightLift); ctx.lineTo( spread, 6); ctx.stroke();
  if(t.glow){ const off=t.flip?-t.pumpOffsetX:t.pumpOffsetX; const x=t.x+off, y=t.y+t.pumpOffsetY; const g=ctx.createRadialGradient(x,y,4,x,y,34); g.addColorStop(0,'#fff6b0'); g.addColorStop(1,'#ff9f00'); ctx.globalCompositeOperation='lighter'; ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,30,0,Math.PI*2); ctx.fill(); ctx.globalCompositeOperation='source-over' }
  ctx.restore();
  if(t.kind==='boss'){ const hpPerc=Math.max(0,(t.hp||0)/6); ctx.fillStyle='rgba(0,0,0,0.65)'; ctx.fillRect(t.x-50,t.y-t.h-18,100,10); ctx.fillStyle='lime'; ctx.fillRect(t.x-50,t.y-t.h-18,100*hpPerc,10); ctx.strokeStyle='#000'; ctx.strokeRect(t.x-50,t.y-t.h-18,100,10) }
}
function drawBat(t){ const s=(performance.now()-t.animStart)/1000; const flap=1+0.15*Math.sin(s*10); const bob=4*Math.sin(s*3); ctx.save(); ctx.translate(t.x,t.y+bob); ctx.scale(t.flip?-1:1,flap); if(batImg.complete) ctx.drawImage(batImg,-t.w/2,-t.h/2,t.w,t.h); ctx.restore() }
function drawGhost(t){ const s=(performance.now()-t.animStart)/1000; const bob=6*Math.sin(s*2+t.seed); const fade=0.6+0.4*Math.sin(s*3+t.seed); ctx.save(); ctx.globalAlpha=0.6+0.4*fade; ctx.translate(t.x,t.y+bob); if(ghostImg.complete) ctx.drawImage(ghostImg,-t.w/2,-t.h/2,t.w,t.h); ctx.restore() }

let game=null;
function newGame(){
  const careerRank = safeLSGet('pk_career_rank','Rookie');
  bestRankEl.textContent = careerRank;
  return { running:true, ended:false, t:0, timeLeft:60, score:0, combo:0, misses:0, targets:[], spawnInt:900, accelEach:8000, lastSpawn:0, lastAccel:0, minSpawn:300, shakeTime:0, shakeMag:0, lastHitTime:0, blackoutMs:0, glowId:null, bossIntro:null, timescale:1, frenzy:false, mult:1, nextBossAt:22000+Math.random()*6000, telegraphed:false, rank:"Rookie", firstWave:false, glowEnabledAt:5000, specialSpawned:false, maxTargets:20 }
}
const rankSteps=[{n:"Rookie",t:0},{n:"Slayer",t:100},{n:"King",t:200},{n:"Overlord",t:350},{n:"Pump-King",t:500}];
function updateRank(g){
  const cur=rankSteps.filter(r=>g.score>=r.t).pop();
  if(cur && cur.n!==g.rank){
    g.rank=cur.n; rankEl.textContent=g.rank; rankText="RANK UP: "+g.rank; rankFx=rankMax; rankUpSound();
    const career = safeLSGet('pk_career_rank','Rookie');
    const order = n=>rankSteps.findIndex(r=>r.n===n);
    if(order(g.rank)>order(career)){ safeLSPut('pk_career_rank',g.rank); bestRankEl.textContent=g.rank }
    addFloat(g.rank, W/2, 120, "rgba(255,230,120,");
  }
}

function floorY(){ return H-64 }
function lanes3(){ const f=floorY(); return [f-20, f-90, f-160] }

function spawnZombie(g){
  if(g.targets.length>=g.maxTargets) return;
  const L=lanes3(); const y=L[Math.floor(Math.random()*L.length)];
  const fromLeft=Math.random()<0.5; const x=fromLeft?-60:W+60;
  const speed=0.08+Math.random()*0.07; const scale=0.9+Math.random()*0.2;
  const w=140*scale, h=200*scale; const bodyR=26*scale*HITBOX_SCALE, pumpR=24*scale*HITBOX_SCALE;
  const pumpOffsetX=-20*scale, pumpOffsetY=-60*scale;
  const z={id:rid(),kind:'zombie',x,y,vx:fromLeft?speed:-speed,vy:0,dead:false,flip:!fromLeft,w,h,bodyR,pumpR,pumpOffsetX,pumpOffsetY,animStart:performance.now(),seed:Math.random()*Math.PI*2,stepAmp:6*scale,bobAmp:3*scale,swayAmp:0.06,squashAmp:0.04,canSwap:true,hp:1,glow:false};
  g.targets.push(z); g.firstWave=true;
}
function spawnBoss(g){
  if(!g.firstWave) return;
  const existing=g.targets.filter(t=>t.kind==='boss'&&!t.dead).length;
  if(existing>=1) return;
  const L=lanes3().slice(0,2); const y=L[Math.floor(Math.random()*L.length)];
  const fromLeft=Math.random()<0.5; const x=fromLeft?-110:W+110;
  const vx=fromLeft?0.06:-0.06; const scale=1.4;
  const w=190*scale, h=260*scale; const bodyR=40*scale*HITBOX_SCALE, pumpR=36*scale*HITBOX_SCALE;
  const pumpOffsetX=-30*scale, pumpOffsetY=-78*scale;
  const boss={id:rid(),kind:'boss',x,y,vx,vy:0,dead:false,flip:!fromLeft,w,h,bodyR,pumpR,pumpOffsetX,pumpOffsetY,animStart:performance.now(),seed:Math.random()*Math.PI*2,stepAmp:7*scale,bobAmp:4*scale,swayAmp:0.05,squashAmp:0.03,hp:6,glow:false};
  g.targets.push(boss);
  g.bossIntro={id:boss.id, t:performance.now()};
  g.timescale=0.35; g.telegraphed=false;
  roarSound();
  g.nextBossAt = g.t + 26000 + Math.random()*10000;
}
function spawnBat(g){
  if(g.targets.length>=g.maxTargets) return;
  const y=floorY()-120-Math.random()*110; const fromLeft=Math.random()<0.5; const x=fromLeft?-40:W+40;
  const vx=fromLeft?(0.18+Math.random()*0.05):-(0.18+Math.random()*0.05);
  const w=110,h=60; const r=Math.min(w,h)*0.45;
  g.targets.push({id:rid(),kind:'bat',x,y,vx,vy:0,dead:false,animStart:performance.now(),r,flip:!fromLeft,w,h})
}
function spawnGhost(g){
  if(g.targets.length>=g.maxTargets) return;
  const y=floorY()-100-Math.random()*120; const fromLeft=Math.random()<0.5; const x=fromLeft?-60:W+60;
  const vx=fromLeft?(0.08+Math.random()*0.04):-(0.08+Math.random()*0.04);
  const w=120,h=100; const r=42;
  g.targets.push({id:rid(),kind:'ghost',x,y,vx,vy:0,dead:false,animStart:performance.now(),r,flip:!fromLeft,w,h,seed:Math.random()*6.28})
}
function spawnSprinter(g){
  if(g.specialSpawned || g.targets.length>=g.maxTargets) return;
  g.specialSpawned=true;
  const L=lanes3().slice(0,2); const y=L[Math.floor(Math.random()*L.length)];
  const fromLeft=Math.random()<0.5; const x=fromLeft?-80:W+80;
  const vx=fromLeft?0.65:-0.65;
  const scale=1.05;
  const w=150*scale, h=210*scale; const bodyR=28*scale*HITBOX_SCALE, pumpR=26*scale*HITBOX_SCALE;
  const pumpOffsetX=-22*scale, pumpOffsetY=-62*scale;
  const t={id:rid(),kind:'sprinter',x,y,vx,vy:0,dead:false,flip:!fromLeft,w,h,bodyR,pumpR,pumpOffsetX,pumpOffsetY,animStart:performance.now(),seed:Math.random()*Math.PI*2,stepAmp:7*scale,bobAmp:5*scale,swayAmp:0.06,squashAmp:0.05,hp:1,glow:true,ttl:4000,spawnedAt:performance.now()};
  g.targets.push(t);
}
function rid(){ return Math.random().toString(36).slice(2)+Math.random().toString(36).slice(2) }

function today(){ const d=new Date(); return d.toISOString().slice(0,10) }
function safeLSGet(key, def){ try{ const raw=localStorage.getItem(key); return raw?JSON.parse(raw):def }catch{ return def } }
function safeLSPut(key,val){ try{ localStorage.setItem(key, JSON.stringify(val)) }catch{} }
function loadMission(){ let m=safeLSGet('pk_mission',null); if(!m || m.day!==today()){ m={day:today(),goalGlow:3,hitGlow:0,done:false}; safeLSPut('pk_mission',m) } return m }
function saveMission(m){ safeLSPut('pk_mission',m); renderMission() }
function renderMission(){ const m=loadMission(); missionBox.textContent = m.done?`Completed â€¢ Hit ${m.goalGlow}/${m.goalGlow} glowing pumpkins`: `Hit ${m.hitGlow}/${m.goalGlow} glowing pumpkins today` }
resetMissionBtn.onclick=()=>{ try{ localStorage.removeItem('pk_mission') }catch{} renderMission() }

function startBlackout(g){
  if(g.t<g.glowEnabledAt) return;
  g.blackoutMs=800; g.glowId=null; g.targets.forEach(t=>t.glow=false);
  const list=g.targets.filter(t=>(t.kind==='zombie'||t.kind==='boss')&&!t.dead);
  if(list.length){ const pick=list[Math.floor(Math.random()*list.length)]; pick.glow=true; g.glowId=pick.id }
}
function clearGlow(g){ g.targets.forEach(t=>t.glow=false); g.glowId=null; g.blackoutMs=0 }

function update(dt,g){
  const scale=g.timescale||1; const dte=Math.min(34,dt)*scale;
  g.t+=dte; g.timeLeft=Math.max(0,g.timeLeft-dte/1000);
  if(!g.frenzy && g.timeLeft<=30){ g.frenzy=true; g.mult=2; g.spawnInt=Math.max(260,g.spawnInt*0.6); modeEl.textContent='x2' }
  if(g.timeLeft<=0) g.running=false;
  if(g.t-g.lastAccel>g.accelEach){ g.lastAccel=g.t; g.spawnInt=Math.max(g.minSpawn,g.spawnInt*0.92) }
  if(!g.telegraphed && g.t>g.nextBossAt-3000){ g.telegraphed=true }
  if(g.blackoutMs>0){ g.blackoutMs-=dte; if(g.blackoutMs<=0) clearGlow(g) }
  else if(g.t-g.lastSpawn>g.spawnInt){
    g.lastSpawn=g.t;
    const r=Math.random();
    if(r<0.65) spawnZombie(g);
    else if(r<0.85) spawnBat(g);
    else if(r<0.95) spawnGhost(g);
    if(g.t>g.nextBossAt) spawnBoss(g);
    if(Math.random()<0.07) startBlackout(g);
  }
  if(!g.specialSpawned && g.t>10000) spawnSprinter(g);
  if(g.bossIntro){ const age=(performance.now()-g.bossIntro.t)/1000; g.timescale=Math.min(1,0.35+age*0.35); if(age>2.2){ g.timescale=1; g.bossIntro=null } }
  for(const t of g.targets){
    t.x+=t.vx*dte;
    const wind=0.015*Math.sin((performance.now()+t.x)*0.002); t.x+=wind*dte;
    if(t.kind==='sprinter' && performance.now()-t.spawnedAt>t.ttl) t.dead=true;
    if((t.kind==='zombie'||t.kind==='boss'||t.kind==='sprinter') && t.canSwap && Math.random()<0.0015){ const L=lanes3(); t.y=L[Math.floor(Math.random()*L.length)]; t.canSwap=false }
    if(t.x<-200||t.x>W+200||t.y<-160||t.y>H+160) t.dead=true
  }
  g.targets=g.targets.filter(z=>!z.dead);
  if(g.shakeTime>0){ g.shakeTime-=dte; if(g.shakeTime<=0) g.shakeMag=0 }
  if(g.lastHitTime && performance.now()-g.lastHitTime>2000){ g.combo=0; g.lastHitTime=0; comboFlame=0 }
  if(g.glowId && !g.targets.some(t=>t.id===g.glowId)){ clearGlow(g) }
  updateFx(dte)
}

function render(g){
  const sx=g.shakeMag?(Math.random()-0.5)*g.shakeMag:0;
  const sy=g.shakeMag?(Math.random()-0.5)*g.shakeMag:0;
  ctx.save(); ctx.translate(sx,sy);
  drawBackground();
  for(const t of g.targets){
    if(t.kind==='zombie'||t.kind==='boss'||t.kind==='sprinter') drawChar(t);
    else if(t.kind==='bat') drawBat(t);
    else if(t.kind==='ghost') drawGhost(t);
  }
  if(g.blackoutMs>0){ ctx.fillStyle='rgba(0,0,0,0.65)'; ctx.fillRect(0,0,W,H); g.targets.forEach(t=>{ if(t.glow) drawChar(t) }) }
  if(g.bossIntro){ const age=(performance.now()-g.bossIntro.t)/1000; ctx.save(); ctx.globalAlpha=0.25+0.25*Math.sin(age*8); ctx.fillStyle='#ffb36b'; ctx.font='900 56px system-ui, Arial'; ctx.textAlign='center'; ctx.fillText("BOSS!", W/2, 110); ctx.restore() }
  drawCrosshair();
  drawComboFlames();
  drawFx();
  ctx.restore()
}

function drawComboFlames(){
  if(comboFlame<=0) return;
  const a=Math.min(1,comboFlame/600);
  const r=60+20*Math.sin(performance.now()/90);
  const g=ctx.createRadialGradient(mouseX,mouseY,4,mouseX,mouseY,r);
  g.addColorStop(0,`rgba(255,190,90,${0.45*a})`);
  g.addColorStop(1,`rgba(255,90,0,0)`);
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(mouseX,mouseY,r,0,Math.PI*2); ctx.fill();
}

function shake(g,ms,mag){ g.shakeTime=ms; g.shakeMag=mag }

function shootAt(g,mx,my){
  let pick=null,best=9999,val=0, kind='none';
  for(const z of g.targets){
    if(z.kind==='zombie'||z.kind==='boss'||z.kind==='sprinter'){
      const bodyD=Math.hypot(mx-z.x,my-(z.y - z.h*0.55));
      const off=z.flip?-z.pumpOffsetX:z.pumpOffsetX;
      const px=z.x+off, py=z.y+z.pumpOffsetY;
      const pumpD=Math.hypot(mx-px,my-py);
      const d=Math.min(bodyD,pumpD);
      if(d<best && (bodyD<z.bodyR || pumpD<z.pumpR)){ best=d; pick={z,pump:(pumpD<z.pumpR),px,py}; kind='target' }
    } else if(z.kind==='bat'||z.kind==='ghost'){ const d=Math.hypot(mx-z.x,my-z.y); if(d<(z.r||40) && d<best){ best=d; pick={z}; kind=z.kind } }
  }
  if(!pick){ miss(g,mx,my); return }

  if(kind==='bat'){ pick.z.dead=true; val=-2; addFloat("-2", pick.z.x, pick.z.y-24, "rgba(255,80,80,"); badHitSound() }
  else if(kind==='ghost'){ pick.z.dead=true; val=5*g.mult; spawnPop(pick.z.x,pick.z.y); addFloat("+5", pick.z.x, pick.z.y-20, "rgba(200,230,255,"); hitSound("pumpGlow") }
  else{
    const z=pick.z; const glow=z.glow===true;
    if(z.kind==='boss'){
      if(pick.pump){ val=(glow?12:4)*g.mult; spawnPop(pick.px,pick.py); addFloat("+"+val, pick.px, pick.py-16, glow?"rgba(120,220,255,":"rgba(255,230,120,"); hitSound(glow?"pumpGlow":"pump") }
      else { val=2*g.mult; addFloat("+"+val, z.x, z.y-z.h*0.6, "rgba(255,200,120,"); hitSound("body") }
      const before=z.hp||6; z.hp=before-1; if(before!==z.hp) lowRoar();
      if(z.hp<=0) z.dead=true;
      if(glow){ clearGlow(g); if(Math.random()<0.08){ g.timeLeft=Math.min(90,g.timeLeft+5); addFloat("+5s", z.x, z.y-90, "rgba(120,220,255,"); } const m=loadMission(); if(!m.done){ m.hitGlow++; if(m.hitGlow>=m.goalGlow){ m.done=true; addFloat("MISSION!", W/2, H*0.3, "rgba(255,230,120,"); rankUpSound() } saveMission(m) } }
    } else if(z.kind==='sprinter'){
      val = pick.pump ? 12*g.mult : 6*g.mult;
      spawnPop(pick.px||z.x,pick.py||z.y);
      addFloat("+"+val, (pick.px||z.x), (pick.py||z.y)-16, pick.pump?"rgba(120,220,255,":"rgba(255,230,120,");
      hitSound(pick.pump?"pumpGlow":"pump"); z.dead=true;
    } else {
      if(pick.pump){ val=(glow?10:2)*g.mult; spawnPop(pick.px,pick.py); addFloat("+"+val, pick.px, pick.py-16, glow?"rgba(120,220,255,":"rgba(255,230,120,"); hitSound(glow?"pumpGlow":"pump") }
      else { val=1*g.mult; addFloat("+"+val, z.x, z.y-z.h*0.6, "rgba(255,200,120,"); hitSound("body") }
      z.hp=(z.hp||1)-1; if(z.hp<=0) z.dead=true;
      if(glow){ clearGlow(g); if(Math.random()<0.08){ g.timeLeft=Math.min(90,g.timeLeft+5); addFloat("+5s", z.x, z.y-70, "rgba(120,220,255,"); } const m=loadMission(); if(!m.done){ m.hitGlow++; if(m.hitGlow>=m.goalGlow){ m.done=true; addFloat("MISSION!", W/2, H*0.3, "rgba(255,230,120,"); rankUpSound() } saveMission(m) } }
    }
  }

  g.score+=val;
  if(val>0){
    g.combo+=1; g.lastHitTime=performance.now();
    if(g.combo>=5){ comboFlame=Math.min(1200, comboFlame+200) }
  } else { g.combo=0; comboFlame=0 }
  updateRank(g);
  comboEl.textContent=g.combo|0
}

function miss(g,x,y){ g.combo=0; comboFlame=0; g.score=Math.max(0,g.score-1); g.misses+=1; addFloat("-1", x, y, "rgba(255,80,80,"); missSound() }

function drawHUD(g){ scoreEl.textContent=g.score|0; timeEl.textContent=Math.ceil(g.timeLeft); comboEl.textContent=g.combo|0; missEl.textContent=g.misses|0; rankEl.textContent=g.rank; modeEl.textContent='x'+g.mult }

let audioCtx=null, muted=false;
function ensureAudio(){ try{ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)() }catch{} }
function blip(fStart,fEnd,dur,gain,type){
  if(muted) return;
  try{ ensureAudio(); if(!audioCtx) return; const minF=20; fStart=Math.max(minF,fStart); fEnd=Math.max(minF,fEnd); const t0=audioCtx.currentTime; const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type=type; o.frequency.setValueAtTime(fStart,t0); o.frequency.linearRampToValueAtTime(fEnd,t0+dur); g.gain.setValueAtTime(gain,t0); g.gain.exponentialRampToValueAtTime(0.0001,t0+dur); o.connect(g); g.connect(audioCtx.destination); o.start(t0); o.stop(t0+dur) }catch{} }
function hitSound(kind){ if(kind==="pumpGlow") blip(1100,300,0.12,0.12,"triangle"); else if(kind==="pump") blip(900,300,0.11,0.10,"triangle"); else blip(540,220,0.08,0.08,"square") }
function badHitSound(){ blip(240,160,0.07,0.07,"square") }
function missSound(){ blip(180,110,0.08,0.07,"sawtooth") }
function rankUpSound(){ if(muted) return; try{ ensureAudio(); if(!audioCtx) return; const t0=audioCtx.currentTime; const g=audioCtx.createGain(); g.gain.value=0.12; g.connect(audioCtx.destination); const o=audioCtx.createOscillator(); o.type='triangle'; o.frequency.setValueAtTime(440,t0); o.frequency.linearRampToValueAtTime(880,t0+0.25); g.gain.exponentialRampToValueAtTime(0.0001,t0+0.3); o.connect(g); o.start(t0); o.stop(t0+0.3) }catch{} }
function roarSound(){ if(muted) return; try{ ensureAudio(); if(!audioCtx) return; const t0=audioCtx.currentTime; const g=audioCtx.createGain(); g.gain.value=0.18; g.connect(audioCtx.destination); const noiseBuf=audioCtx.createBuffer(1, audioCtx.sampleRate*1.2, audioCtx.sampleRate); const d=noiseBuf.getChannelData(0); for(let i=0;i<d.length;i++){ d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,1.4) } const n=audioCtx.createBufferSource(); n.buffer=noiseBuf; const bp=audioCtx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.setValueAtTime(220,t0); bp.Q.value=1.2; n.connect(bp); bp.connect(g); n.start(t0); g.gain.setValueAtTime(0.18,t0); g.gain.exponentialRampToValueAtTime(0.0001,t0+1.2); n.stop(t0+1.2) }catch{} }
function lowRoar(){ if(muted) return; try{ ensureAudio(); if(!audioCtx) return; const t0=audioCtx.currentTime; const g=audioCtx.createGain(); g.gain.value=0.10; g.connect(audioCtx.destination); const o=audioCtx.createOscillator(); o.type='sawtooth'; o.frequency.setValueAtTime(90,t0); g.gain.setValueAtTime(0.10,t0); g.gain.exponentialRampToValueAtTime(0.0001,t0+0.5); o.connect(g); o.start(t0); o.stop(t0+0.5) }catch{} }

let mouseX=0,mouseY=0;
function drawCrosshair(){
  const r=6;
  ctx.save(); ctx.translate(mouseX,mouseY);
  ctx.strokeStyle='rgba(255,235,150,0.95)'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(-10,0); ctx.lineTo(-5,0); ctx.moveTo(5,0); ctx.lineTo(10,0); ctx.moveTo(0,-10); ctx.lineTo(0,-5); ctx.moveTo(0,5); ctx.lineTo(0,10); ctx.stroke();
  ctx.restore();
}
function setGun(x,y){
  if(isCoarse){ gunImg.style.display='none'; return }
  const cx=W*0.5, cy=H*0.75;
  const nx=(x-cx)/(W*0.5), ny=(y-cy)/(H*0.5);
  const baseX=W*0.50 + nx*40;
  const baseY=H*0.98 + ny*8;
  gunImg.style.left=baseX+'px';
  gunImg.style.top=baseY+'px';
  const roll = nx*6;
  const pitch = -3 - ny*4;
  gunImg.style.transform=`translate(-50%,-100%) rotateZ(${roll}deg) rotateX(${pitch}deg)`;
}
wrap.addEventListener('pointerenter',()=>{ if(!isCoarse) gunImg.style.display='block' });
wrap.addEventListener('pointerleave',()=>{ if(!isCoarse) gunImg.style.display='none' });
wrap.addEventListener('pointermove',e=>{ const r=wrap.getBoundingClientRect(); mouseX=e.clientX-r.left; mouseY=e.clientY-r.top; setGun(mouseX,mouseY) });
wrap.addEventListener('pointerdown',()=>{ if(!game||!game.running) return; try{ ensureAudio(); if(audioCtx?.state==='suspended') audioCtx.resume().catch(()=>{}) }catch{}; shootAt(game,mouseX,mouseY) });

let last=performance.now(), rafId=null;
function loop(ts){
  try{
    const rawDt = ts-last; last=ts;
    const dt = Math.min(34, Math.max(0, rawDt));
    if(game){
      if(game.running) update(dt,game); else updateFx(dt);
      render(game); drawHUD(game);
      if(game && !game.running && !game.ended){ game.ended=true; endSummary(game) }
    }
  }catch(e){ console.error('loop error', e) }finally{ rafId=requestAnimationFrame(loop) }
}

function start(){
  if(rafId){ cancelAnimationFrame(rafId); rafId=null }
  overlay.style.display='none'; startOverlay.style.display='none';
  pops.length=0; floats.length=0; comboFlame=0;
  game=newGame();
  submitBtn.disabled=true; last=performance.now();
  renderMission(); rankEl.textContent=game.rank; modeEl.textContent='x1';
  rafId=requestAnimationFrame(loop);
}
function endSummary(g){
  let bonus=0;
  if(g.misses===0 && g.score>0){ bonus=Math.max(10,Math.round(g.score*0.1)); g.score+=bonus }
  const best=saveLocalScore(g.score);
  const bonusText=bonus?` â€¢ No-Miss Bonus +${bonus}`:'';
  overScoreEl.textContent=`Score: ${g.score}${bonusText} â€¢ Best: ${best} â€¢ Misses: ${g.misses} â€¢ Rank: ${g.rank}`;
  overlay.style.display='flex';
}

function saveLocalScore(score){
  const key='pk_local_leaderboard';
  const arr=safeLSGet(key,[]);
  const name=currentWallet()||'guest';
  arr.push({name,score,t:Date.now()});
  arr.sort((a,b)=>b.score-a.score);
  const top=arr.slice(0,10);
  safeLSPut(key,top);
  renderBoard();
  const mine=top.filter(x=>x.name===name).map(x=>x.score);
  return mine.length?Math.max(...mine):score;
}
function renderBoard(){ const arr=safeLSGet('pk_local_leaderboard',[]); boardEl.innerHTML=arr.map((x,i)=>`<li>#${i+1} ${escapeHtml(x.name.slice(0,10))} â€” ${x.score}</li>`).join('') }
function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&quot;',"'":'&#39;'}[m]))}

bigPlay.onclick=()=>start();
playAgainBtn.onclick=()=>start();
muteStart.onchange=()=>{ muted=muteStart.checked; muteChk.checked=muted };
muteOverBtn.onclick=()=>{ muted=!muted; muteChk.checked=muted; muteStart.checked=muted };
muteChk.onchange=()=>{ muted=muteChk.checked; muteStart.checked=muted };
shareOverBtn.onclick=()=>shareNow();
refreshLbBtn.onclick=()=>renderBoard();

let wallet=null;
function currentWallet(){ return wallet?wallet.slice(0,4)+'â€¦'+wallet.slice(-4):null }
async function connectWallet(){ try{ const provider=window.solana||window.phantom?.solana; if(!provider){ walletBox.textContent='Phantom not found'; return } const res=await provider.connect({onlyIfTrusted:false}); wallet=res.publicKey.toString(); walletBox.textContent='Connected: '+wallet }catch(e){ walletBox.textContent='Wallet error' } }
connectBtn.onclick=()=>connectWallet();

signBtn.onclick=async()=>{ try{ const provider=window.solana||window.phantom?.solana; if(!provider){ alert('Install Phantom'); return } if(!wallet) await connectWallet(); const enc=new TextEncoder(); const msg=`Pump Gyatt | score=${game?game.score:0} | rank=${game?game.rank:'Rookie'} | ts=${Date.now()} | wallet=${wallet}`; const signed=await provider.signMessage(enc.encode(msg),'utf8'); const hex=[...new Uint8Array(signed.signature)].map(b=>b.toString(16).padStart(2,'0')).join(''); await navigator.clipboard.writeText(hex); alert('Score signed. Signature copied to clipboard.') }catch(e){ alert('Sign failed') } };

submitBtn.onclick=()=>{ if(!game) return; if(game.score<10) return; saveLocalScore(game.score); submitBtn.disabled=true };

function shareNow(){
  const url=encodeURIComponent(location.href);
  const rank=game?game.rank:'Rookie';
  const sc=encodeURIComponent(`I scored ${game?game.score:0} (Rank: ${rank}) on ðŸŽ¯ Pump Gyatt!`);
  window.open(`https://twitter.com/intent/tweet?text=${sc}&url=${url}`,'_blank');
}
shareBtn.onclick=()=>shareNow();

renderBoard();
bestRankEl.textContent = safeLSGet('pk_career_rank','Rookie');
startOverlay.style.display='flex';
</script>
</body>
</html>
